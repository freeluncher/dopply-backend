name: Deploy FastAPI to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Create .env file from GitHub Secrets
      run: |
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
        echo "ALGORITHM=${{ secrets.ALGORITHM }}" >> .env
        echo "ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" >> .env

    - name: Deploy to Ubuntu VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        password: ${{ secrets.VM_PASSWORD }}
        port: 22
        script: |
          cd ~/dopply-backend
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_USER=${{ secrets.DATABASE_USER }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "ALGORITHM=${{ secrets.ALGORITHM }}" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" >> .env

          echo "ğŸ“ Login sebagai $(whoami)"
          cd ~

          # Hapus jika folder rusak/tidak ada .git
          if [ -d "dopply-backend" ]; then
            if [ ! -d "dopply-backend/.git" ]; then
              echo "âš ï¸ Folder dopply-backend rusak. Menghapus..."
              rm -rf dopply-backend
            fi
          fi

          # Clone jika belum ada
          if [ ! -d "dopply-backend" ]; then
            echo "ğŸ“ Cloning repository dari GitHub..."
            git clone https://${{ secrets.USERNAME }}:${{ secrets.PAT_TOKEN }}@github.com/freeluncher/dopply-backend.git
          fi

          cd dopply-backend

          echo "ğŸ”„ Sinkronisasi penuh dengan repo GitHub..."
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

          # Copy .env dari home jika ada
          if [ -f "../.env" ]; then
            cp ../.env .env
          fi

          echo "ğŸ Setup virtual environment dan dependency..."

          # Install pip dan venv jika belum ada
          if ! command -v pip &> /dev/null; then
            echo "ğŸ“¦ pip tidak ditemukan, install..."
            sudo apt update && sudo apt install -y python3-pip python3-venv
          fi

          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "ğŸ” Restart FastAPI systemd service..."
          sudo systemctl restart dopply.service

          echo "ğŸ” Reloading NGINX..."
          sudo systemctl reload nginx

          echo "âœ… Deployment berhasil!"
